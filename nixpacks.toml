[phases.setup]
nixPkgs = ["php82", "php82Packages.composer", "nodejs_18"]

[phases.install]
cmds = [
  "composer install --no-dev --optimize-autoloader",
  "npm ci --include=dev"
]

[phases.build]
cmds = [
  "mkdir -p public/build",
  "echo 'Building assets with Vite...'",
  "npm run build || (echo 'Build failed!' && exit 1)",
  "echo 'Verifying build output...'",
  "test -f public/build/.vite/manifest.json || (echo 'Manifest file missing at public/build/.vite/manifest.json!' && ls -la public/build/ && ls -la public/build/.vite/ 2>/dev/null || echo 'No .vite directory found' && exit 1)",
  "grep -q 'resources/css/app.css' public/build/.vite/manifest.json || (echo 'CSS manifest entry missing' && cat public/build/.vite/manifest.json && exit 1)",
  "ls -la public/build/assets/*.css || (echo 'No CSS assets found' && ls -la public/build/assets/ && exit 1)",
  "ls -la public/build/assets/*.js || (echo 'No JS assets found' && ls -la public/build/assets/ && exit 1)",
  "echo 'Build completed successfully!'"
]

[start]
cmd = "chmod +x start.sh && ./start.sh"
